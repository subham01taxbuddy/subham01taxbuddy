<ngx-loading
  [show]="loading"
  [config]="{ backdropBorderRadius: '14px', fullScreenBackdrop: true }"
></ngx-loading>
<div class="mrgArd" *ngIf="bondType === 'listed'">
  <app-file-parser (newDataAvailable)="getFileParserData()"></app-file-parser>
</div>


<div class="mrgArd">
<mat-accordion class="headers-align">
  <mat-expansion-panel
    [expanded]="step === 1"
    step="1"
    hideToggle
    class="hide-close"
  >
    <mat-expansion-panel-header>
      <mat-panel-title>
        <mat-icon> arrow_forward_ios </mat-icon>
        {{ title }}
      </mat-panel-title>
      <div class="card__row edit clearfix isShow">
        <button class="edit_btn" (click)="$event.stopPropagation(); addMore()">
          <i class="fa fa-plus"></i>Add
        </button>
      </div>
    </mat-expansion-panel-header>
    <div *ngIf="compactView">
      <mat-accordion class="headers-align">
        <mat-expansion-panel
          *ngFor="let securities of brokerList"
          (click)="showBroker(securities.brokerName)"
        >
          <mat-expansion-panel-header
            class="card__row drop"
            (click)="showBroker(securities.brokerName)"
          >
            <div class="card__col-xs-12">
              <div class="card__col-xs-12 card__col-sm-3">
                <div class="title">Broker Name</div>
                <div class="value">{{ securities.brokerName }}</div>
              </div>
              <div class="card__col-xs-12 card__col-sm-3">
                <div class="title">LTCG</div>
                <div class="value">{{ securities.LTCG }}</div>
              </div>
              <div class="card__col-xs-12 card__col-sm-3">
                <div class="title">STCG</div>
                <div class="value">{{ securities.STCG }}</div>
              </div>
            </div>
          </mat-expansion-panel-header>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
    <div class="card" *ngIf="!compactView">
      <form [formGroup]="securitiesForm">
        <div formArrayName="securitiesArray">
          <div
            class="mvTp"
            *ngFor="
              let securities of getSecuritiesArray.controls | paginate : config;
              let i = index
            "
            [formGroupName]="fieldGlobalIndex(i)"
          >
            <mat-checkbox              
              name="hasEdit[i]"
              formControlName="hasEdit"
              class=""
            >
            </mat-checkbox>
            <div class="row cardClr">
              <div class="col-sm-4">
                <mat-label>Scrip Name</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    formControlName="nameOfTheUnits"
                    placeholder="Scrip Name"
                    name="nameOfTheUnits"
                    maxlength="14"
                    (change)="calculateTotalCG(securities)"
                    oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                  />
                  <mat-hint style="font-size: 75%"
                    >If Scrip Name is not available you can enter
                    INNOTREQUIRD</mat-hint
                  >
                  <mat-error
                    *ngIf="
                      getSecuritiesArray.controls[i].controls[
                        'nameOfTheUnits'
                      ].hasError('pattern')
                    "
                    >Enter valid amount.</mat-error
                  >
                </mat-form-field>
              </div>
              <div class="col-sm-4">
                <mat-label>Buy/Sell Quantity</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    formControlName="sellOrBuyQuantity"
                    placeholder="Sell/Buy Quantity"
                    name="sellOrBuyQuantity"
                    maxlength="14"
                    (change)="calculateTotalCG(securities)"
                    oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                    (blur)="
                      securitiesForm.controls['securitiesArray'].controls[
                        fieldGlobalIndex(i)
                      ].controls['sellValue'].setValue(
                        securitiesForm.controls['securitiesArray'].controls[
                          fieldGlobalIndex(i)
                        ].controls['sellValuePerUnit'].value *
                          securitiesForm.controls['securitiesArray'].controls[
                            fieldGlobalIndex(i)
                          ].controls['sellOrBuyQuantity'].value
                      )
                    "
                    (blur)="
                      securitiesForm.controls['securitiesArray'].controls[
                        fieldGlobalIndex(i)
                      ].controls['purchaseCost'].setValue(
                        securitiesForm.controls['securitiesArray'].controls[
                          fieldGlobalIndex(i)
                        ].controls['purchaseValuePerUnit'].value *
                          securitiesForm.controls['securitiesArray'].controls[
                            fieldGlobalIndex(i)
                          ].controls['sellOrBuyQuantity'].value
                      )
                    "
                  />

                  <mat-error
                    *ngIf="
                      securitiesForm.controls['securitiesArray'].controls[
                        i
                      ].controls['sellOrBuyQuantity'].hasError('pattern')
                    "
                    >Enter valid amount.</mat-error
                  >
                </mat-form-field>
              </div>
              <div class="col-sm-4">
                <mat-label>Sale Date</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    [min]="minDate"
                    [max]="maxDate"
                    formControlName="sellDate"
                    name="sellDate"
                    readonly
                    [matDatepicker]="sellDate"
                    placeholder="DD/MM/YYYY"
                    (dateChange)="
                      calculateGainType(securities);
                      calculateTotalCG(securities);
                      calMaxPurchaseDate(
                        this.securitiesForm.controls['securitiesArray']
                          .controls[i].controls['sellDate'].value,
                        this.securitiesForm,
                        i
                      )
                    "
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="sellDate"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #sellDate> </mat-datepicker>
                  <mat-error
                    *ngIf="
                      securitiesForm.controls['securitiesArray'].controls[
                        i
                      ].controls['sellDate'].hasError('required')
                    "
                  >
                    Enter valid Date.
                  </mat-error>
                  <mat-error
                    *ngIf="
                      securitiesForm.controls['securitiesArray'].controls[
                        i
                      ].controls['sellDate'].hasError('dateOrder')
                    "
                  >
                    Sale date must be after purchase date.
                  </mat-error>
                </mat-form-field>
              </div>
              <div class="col-sm-4 spsTp">
                <mat-label>Sale Price</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    formControlName="sellValuePerUnit"
                    placeholder="Sale Price"
                    name="sellValuePerUnit"
                    maxlength="14"
                    (change)="calculateTotalCG(securities)"
                    (blur)="
                      securitiesForm.controls['securitiesArray'].controls[
                        fieldGlobalIndex(i)
                      ].controls['sellValue'].setValue(
                        securitiesForm.controls['securitiesArray'].controls[
                          fieldGlobalIndex(i)
                        ].controls['sellValuePerUnit'].value *
                          securitiesForm.controls['securitiesArray'].controls[
                            fieldGlobalIndex(i)
                          ].controls['sellOrBuyQuantity'].value
                      )
                    "
                    oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                  />
                  <mat-error
                    *ngIf="
                      securitiesForm.controls['securitiesArray'].controls[
                        i
                      ].controls['sellValuePerUnit'].hasError('pattern')
                    "
                    >Enter valid amount.</mat-error
                  >
                </mat-form-field>
              </div>
              <div class="col-sm-4 spsTp">
                <mat-label>Sale Value</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    formControlName="sellValue"
                    placeholder="Sale Value"
                    name="sellValue"
                    maxlength="14"
                    required
                    readonly
                    (change)="
                      calculateTotalCG(securities); calculateDeductionGain()
                    "
                    oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                  />
                  <mat-error
                    *ngIf="
                      securitiesForm.controls['securitiesArray'].controls[
                        i
                      ].controls['sellValue'].hasError('pattern')
                    "
                    >Enter valid amount.</mat-error
                  >
                </mat-form-field>
              </div>
              <div class="col-sm-4 spsTp">
                <mat-label>Buy Date</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    [max]="maxPurchaseDate"
                    formControlName="purchaseDate"
                    name="purchaseDate"
                    [matDatepicker]="purchaseDate"
                    placeholder="DD/MM/YYYY"
                    readonly
                    (dateChange)="
                      calculateGainType(securities);
                      calculateTotalCG(securities)
                    "
                  />
                  <mat-datepicker-toggle
                    matSuffix
                    [for]="purchaseDate"
                  ></mat-datepicker-toggle>
                  <mat-datepicker #purchaseDate></mat-datepicker>
                  <mat-error
                    *ngIf="
                      securitiesForm.controls['securitiesArray'].controls[
                        i
                      ].controls['purchaseDate'].hasError('dateOrder')
                    "
                  >
                    Purchase date must be before the sale date.
                  </mat-error>
                </mat-form-field>
              </div>
              <div class="col-sm-4 spsTp">
                <mat-label>Buy Price</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    formControlName="purchaseValuePerUnit"
                    placeholder="Buy Price"
                    name="purchaseValuePerUnit"
                    maxlength="14"
                    (change)="calculateTotalCG(securities)"
                    (blur)="
                      securitiesForm.controls['securitiesArray'].controls[
                        fieldGlobalIndex(i)
                      ].controls['purchaseCost'].setValue(
                        securitiesForm.controls['securitiesArray'].controls[
                          fieldGlobalIndex(i)
                        ].controls['purchaseValuePerUnit'].value *
                          securitiesForm.controls['securitiesArray'].controls[
                            fieldGlobalIndex(i)
                          ].controls['sellOrBuyQuantity'].value
                      )
                    "
                    oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                  />
                  <mat-error
                    *ngIf="
                      securitiesForm.controls['securitiesArray'].controls[
                        i
                      ].controls['purchaseValuePerUnit'].hasError('pattern')
                    "
                    >Enter valid amount.</mat-error
                  >
                </mat-form-field>
              </div>
              <div class="col-sm-4 spsTp">
                <mat-label>Buy Value</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    formControlName="purchaseCost"
                    placeholder="Buy Value"
                    name="purchaseCost"
                    maxlength="14"
                    readonly
                    (change)="calculateTotalCG(securities)"
                    oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                  />
                  <mat-error
                    *ngIf="
                      securitiesForm.controls['securitiesArray'].controls[
                        i
                      ].controls['purchaseCost'].hasError('pattern')
                    "
                    >Enter valid amount.</mat-error
                  >
                </mat-form-field>
              </div>
              <div class="col-sm-4 spsTp">
                <mat-label>Expenses</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    formControlName="sellExpense"
                    placeholder="Expenses"
                    name="sellExpense"
                    maxlength="14"
                    (change)="
                      calculateTotalCG(securities); calculateDeductionGain()
                    "
                    oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                  />
                  <mat-error
                    *ngIf="
                      securitiesForm.controls['securitiesArray'].controls[
                        i
                      ].controls['sellExpense'].hasError('pattern')
                    "
                    >Enter valid amount.</mat-error
                  >
                </mat-form-field>
              </div>
              <div class="col-sm-4 spsTp">
                <mat-label>Type of Capital Gain*</mat-label>
                <mat-form-field appearance="outline">
                  <mat-select
                    placeholder="Type of Gain"
                    class="hide"
                    formControlName="gainType"
                    name="gainType[i]"
                  >
                    <mat-option
                      *ngFor="let type of gainTypeList"
                      [value]="type.value"
                    >
                      {{ type.name }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>  
              <div *ngIf="buyDateBefore31stJan && this.bondType === 'listed'">
                      
                <div class="col-sm-4 spsTp">
                  <mat-label>ISIN Code</mat-label>
                  <mat-form-field appearance="outline">
                    <input
                      matInput
                      formControlName="isinCode"
                      placeholder="ISIN Code"
                      name="isinCode"
                      (blur)="calculateFMV(securities)"
                      (change)="calculateFMV(securities)"
                    />
                    <mat-hint style="font-size: 75%"
                      >If ISIN Code is not available, you can enter
                      INNOTREQUIRD</mat-hint
                    >
                  </mat-form-field>
                </div>
                <div class="col-sm-4 spsTp">
                  <mat-label>FMV as on 31st Jan 2018</mat-label>
                  <mat-form-field appearance="outline">
                    <input
                      matInput
                      formControlName="fmvAsOn31Jan2018"
                      placeholder="FMV"
                      name="fmvAsOn31Jan2018"
                      (change)="calculateTotalCG(securities)"
                    />
                  </mat-form-field>
                </div>
                <div class="col-sm-4 spsTp">
                  <mat-label>Cost of acquisition </mat-label>

                  <mat-form-field appearance="outline">
                    <input
                      matInput
                      formControlName="grandFatheredValue"
                      placeholder="GrandFathered Value "
                      name="grandFatheredValue"
                      maxlength="14"
                      matTooltip="Cost of acquisition(as per grandfathering)"
                      matTooltipClass="tab-tooltip"
                      matTooltipPosition="above"
                      readonly
                      (change)="calculateTotalCG(securities)"
                      oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                    />
                    <mat-hint style="font-size: 75%"
                      >As per grandfathering</mat-hint
                    >
                    <mat-error
                      *ngIf="
                        securitiesForm.controls['securitiesArray'].controls[
                          i
                        ].controls['grandFatheredValue'].hasError('pattern')
                      "
                      >Enter valid amount.</mat-error
                    >
                  </mat-form-field>
                </div>             
              <div class="col-sm-4 spsTp">
                <mat-label>Gain Amount*</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    name="assets[i]"
                    placeholder="capitalGain"
                    formControlName="capitalGain"
                    maxlength="14"
                    readonly
                    (change)="calculateDeductionGain()"
                  />
                  <mat-error
                    *ngIf="
                      securitiesForm.controls['securitiesArray'].controls[
                        i
                      ].controls['capitalGain'].hasError('required')
                    "
                    >Total capital Gain is mandatory</mat-error
                  >
                </mat-form-field>
              </div>
              <div class="col-sm-3 spsTp">           
                <button type="button" class="edit-donation mvRth" (click)="editSecuritiesForm(i)">
                  <mat-icon> edit_square </mat-icon>Edit
                </button>           
              </div>
            
            
          </div>
        </div>  
      </div>

          <div class="row spsTp bdrTp">         
              <div class="col-sm-3">
                <button
                  type="submit"
                  class="delete-btn btnGry"
                  (click)="deleteArray()"
                >
                  <i class="fa fa-trash" aria-hidden="true">&nbsp;</i>Delete
                </button>
              </div>
              <div class="col-sm-6">
                <table>
                  <tr
                    *ngFor="
                      let item of getSecuritiesArray.controls
                        | paginate : config
                    "
                  ></tr>
                </table>
                <pagination-controls
                  (pageChange)="pageChanged($event)"
                ></pagination-controls>
              </div>
              <div class="col-sm-3">
                <!-- <button
                  type="submit"
                  class="tbd-btn save-btn mvRth"
                  (click)="showCompactView()"
                >
                  Back
                </button> -->
                <button
                  type="submit"
                  class="tbd-btn save-btn mvRth"
                  [disabled]="securitiesForm.invalid"
                  (click)="save('securities')"
                >
                  Save
                </button>
              </div>
          </div>

        </div>
      </form>
    </div>
  </mat-expansion-panel>
</mat-accordion>
</div>

<div class="mrgArd">
<div class="card bdrArnd">
  <div class="row">
    <div class="col-sm-9 isDeduction">
      Add deduction under section 54F?
      <i
        class="fa fa-info-circle"
        aria-hidden="true"
        matTooltip="Applicable for any capital assets other than residential HP"
        matTooltipClass="tab-tooltip"
        matTooltipPosition="above"
        data-action-type="redirectUrl"
      ></i>
    </div>
    <div class="col-sm-3">
      <mat-radio-group [(ngModel)]="deduction" [disabled]="isDisable" class="mvRth">
        <mat-radio-button
          [value]="true"       
          labelPosition="before"
          >Yes
        </mat-radio-button>
        <mat-radio-button [value]="false" labelPosition="before"
          >No</mat-radio-button
        >
      </mat-radio-group>
    </div>

  </div>

  <form [formGroup]="deductionForm" *ngIf="this.deduction">
      <mat-checkbox
        color="primary"
        name="hasEdit[i]"
        formControlName="hasEdit"
        class="mvTp"
      >
      </mat-checkbox>
      <div class="row cardClr">
        <div class="col-sm-4">
          <mat-label>Type of Deduction*</mat-label>
          <mat-form-field appearance="outline">
            <input
              (change)="calculateDeductionGain()"
              matInput
              readonly
              placeholder=""
              formControlName="underSection"
              name="underSection"
            />
            <mat-error
              *ngIf="
                deductionForm.controls['underSection'].hasError('required')
              "
              >Please enter type of deduction</mat-error
            >
          </mat-form-field>
        </div>
        <div class="col-sm-4">
          <mat-label>Purchase Date of New Asset*</mat-label>
          <mat-form-field appearance="outline">
            <input
              (change)="calculateDeductionGain()"
              matInput
              readonly
              placeholder="Purchase date of new asset"
              formControlName="purchaseDate"
              name="purchaseDate"
              [matDatepicker]="purchaseDate"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="purchaseDate"
            ></mat-datepicker-toggle>
            <mat-datepicker #purchaseDate></mat-datepicker>
            <mat-error
              *ngIf="
                deductionForm.controls['purchaseDate'].hasError('required')
              "
              >Please select date</mat-error
            >
          </mat-form-field>
        </div>
        <div class="col-sm-4">
          <mat-label>Cost of New Asset*</mat-label>
          <mat-form-field appearance="outline">
            <input
              matInput
              digitsOnly
              placeholder="cost of new asset"
              (change)="calculateDeductionGain()"
              formControlName="costOfNewAssets"
              required
              maxlength="14"
            />
            <mat-error
              *ngIf="
                deductionForm.controls['costOfNewAssets'].hasError('required')
              "
              >Please enter cost of new assets</mat-error
            >
          </mat-form-field>
        </div>
        <div class="col-sm-4 spsTp">
          <mat-label>Amount deposited on CGAS*</mat-label>
          <mat-form-field appearance="outline">
            <input
              matInput
              digitsOnly
              placeholder="Amount deposited on CGAS before due date"
              formControlName="investmentInCGAccount"
              required
              maxlength="14"
              matTooltip="Amount deposited on CGAS before due date"
              (change)="calculateDeductionGain()"
              matTooltipClass="tab-tooltip"
              matTooltipPosition="above"
            />
            <mat-error
              *ngIf="
                deductionForm.controls['investmentInCGAccount'].hasError(
                  'required'
                )
              "
              >Please enter amount</mat-error
            >
          </mat-form-field>
        </div>

        <div class="col-sm-4 spsTp">
          <mat-label>Amount of Deduction Claimed*</mat-label>
          <mat-form-field appearance="outline">
            <input
              (change)="calculateDeductionGain()"
              matInput
              readonly
              placeholder="Amount of deduction claimed"
              formControlName="totalDeductionClaimed"
              maxlength="14"
            />
            <mat-error
              *ngIf="
                deductionForm.controls['totalDeductionClaimed'].hasError(
                  'required'
                )
              "
              >Please enter amount</mat-error
            >
          </mat-form-field>
        </div>

        <div class="col-sm-4 spsTp">
          <button
            type="button"
            class="edit-donation mvRthA"
            (click)="deductionForm.enable()"
          >
            <mat-icon> edit_square </mat-icon>Edit
          </button>
        </div>

      </div>
      <!-- Row Ends -->

      
   
  </form>

  <div class="row spsTp bdrTp" *ngIf="deduction">
    <div class="col-sm-9"></div>
    <div class="col-sm-3">
    <button type="submit" class="tbd-btn save-btn mvRth" [disabled]="deductionForm.invalid" (click)="save()">
      Save
    </button>
    </div>
  </div>

</div>
</div>

<div class="flex justify-between p-[30px] back-foot">
  <button class="lgtBtn">
    <mat-icon class="icoAdj">keyboard_backspace</mat-icon>
    <span class="font-semibold" (click)="goBack()"
      >&nbsp;Back to Capital Gain Topics</span
    >
  </button>

  <button class="saveBtnIn">
    <span class="font-semibold" (click)="saveAll()">Save All</span>
  </button>
</div>
