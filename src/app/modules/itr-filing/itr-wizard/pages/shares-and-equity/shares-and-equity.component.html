<ngx-loading
  [show]="loading"
  [config]="{ backdropBorderRadius: '14px', fullScreenBackdrop: true }"
></ngx-loading>
<div class="mrgArd" *ngIf="bondType === 'listed'">
  <app-file-parser (newDataAvailable)="getFileParserData()"></app-file-parser>
</div>

<div class="mrgArd">
  <mat-accordion class="headers-align">
    <mat-expansion-panel
      [expanded]="step === 1"
      step="1"
      hideToggle
      class="hide-close"
    >
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon> arrow_forward_ios </mat-icon>
          {{ title }}
        </mat-panel-title>
        <div class="card__row edit clearfix isShow">
          <button
            *ngIf="compactView || selectedBroker === ''"
            class="edit_btn"
            (click)="$event.stopPropagation(); addMore()"
          >
            <i class="fa fa-plus"></i>Add
          </button>
        </div>
      </mat-expansion-panel-header>
      <div *ngIf="compactView">
        <mat-accordion class="headers-align">
          <div class="card__col-xs-12">
            <div class="card__col-sm-1 delete-icon"></div>
            <div class="card__col-sm-3 broker-view-title">Broker Name</div>
            <div class="card__col-sm-3 broker-view-title">LTCG</div>
            <div class="card__col-sm-3 broker-view-title">STCG</div>
          </div>
          <div
            class="row broker-card"
            *ngFor="let securities of brokerList; let i = index"
          >
            <div class="col-sm-1">
              <!--              <button><i class="fa fa-trash" aria-hidden="true"-->
              <!--                         (click)="$event.stopPropagation();deleteBroker(securities.brokerName)"-->
              <!--                         style="font-size: 18px; cursor: pointer; margin-right: 10px;"></i></button>-->
              <mat-checkbox
                color="primary"
                (change)="changeSelection(i)"
                [ngModel]="brokerSelected[i]"
                class="ml30"
              ></mat-checkbox>
            </div>

            <div
              class="row col-sm-9"
              (click)="showBroker(securities.brokerName)"
            >
              <div class="col-sm-4 broker-view-value">
                {{ securities.brokerName }}
              </div>
              <div class="col-sm-4 broker-view-value">
                {{ securities.LTCG }}
              </div>
              <div class="col-sm-4 broker-view-value">
                {{ securities.STCG }}
              </div>
            </div>
            <div class="col-sm-2 broker-view-btn">
              <button
                type="button"
                style="
                  border: none;
                  background: transparent;
                  font-size: 12px;
                  cursor: pointer;
                "
              >
                <i class="fas fa-chevron-right broker-view-icon"></i>
              </button>
            </div>
          </div>

          <button
            class="delete-btn delete-icon"
            (click)="$event.stopPropagation(); deleteBroker()"
            [disabled]="!isBrokerSelected()"
          >
            <i class="fa fa-trash" aria-hidden="true"></i> Delete
          </button>
        </mat-accordion>
      </div>
      <div class="card" *ngIf="!compactView">
        <ag-grid-angular
          class="ag-theme-balham topSps"
          [gridOptions]="equityGridOptions"
          (rowClicked)="editSecuritiesForm($event)"
        >
        </ag-grid-angular>

        <div class="row spsTp bdrTp">
          <div class="col-sm-3">
            <button
              type="submit"
              class="delete-btn"
              [disabled]="!equitySelected()"
              (click)="deleteArray()"
            >
              <i class="fa fa-trash" aria-hidden="true">&nbsp;</i>Delete
            </button>
          </div>

          <div class="col-sm-3">
            <button type="submit" class="cancel" (click)="showCompactView()">
              Back to Brokers
            </button>
          </div>
        </div>
      </div>
    </mat-expansion-panel>
  </mat-accordion>
</div>

<div class="mrgArd">
  <div class="card bdrArnd">
    <div class="row">
      <div class="col-sm-9 isDeduction">
        Add deduction under section 54F?
        <i
          class="fa fa-info-circle"
          aria-hidden="true"
          matTooltip="Applicable for any capital assets other than residential HP"
          matTooltipClass="tab-tooltip"
          matTooltipPosition="above"
          data-action-type="redirectUrl"
        ></i>
      </div>
      <div class="col-sm-3">
        <mat-radio-group
          [(ngModel)]="deduction"
          [disabled]="isDisable"
          class="mvRth"
          (change)="deductionChanged($event)"
        >
          <mat-radio-button [value]="true" labelPosition="before"
            >Yes
          </mat-radio-button>
          <mat-radio-button [value]="false" labelPosition="before"
            >No</mat-radio-button
          >
        </mat-radio-group>
      </div>
    </div>

    <form [formGroup]="deductionForm" *ngIf="this.deduction">
      <div class="row cardClr">
        <div class="col-sm-4">
          <mat-label>Type of Deduction*</mat-label>
          <mat-form-field appearance="outline">
            <input
              (change)="calculateDeductionGain()"
              matInput
              readonly
              placeholder=""
              formControlName="underSection"
              name="underSection"
            />
            <mat-error
              *ngIf="
                deductionForm.controls['underSection'].hasError('required')
              "
              >Please enter type of deduction</mat-error
            >
          </mat-form-field>
        </div>
        <div class="col-sm-4">
          <mat-label>Purchase Date of New Asset*</mat-label>
          <mat-form-field appearance="outline">
            <input
              (change)="calculateDeductionGain()"
              matInput
              readonly
              placeholder="Purchase date of new asset"
              formControlName="purchaseDate"
              name="purchaseDate"
              [matDatepicker]="purchaseDate"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="purchaseDate"
            ></mat-datepicker-toggle>
            <mat-datepicker #purchaseDate></mat-datepicker>
            <mat-error
              *ngIf="
                deductionForm.controls['purchaseDate'].hasError('required')
              "
              >Please select date</mat-error
            >
          </mat-form-field>
        </div>
        <div class="col-sm-4">
          <mat-label>Cost of New Asset*</mat-label>
          <mat-form-field appearance="outline">
            <input
              matInput
              digitsOnly
              placeholder="cost of new asset"
              (change)="calculateDeductionGain()"
              formControlName="costOfNewAssets"
              required
              maxlength="14"
            />
            <mat-error
              *ngIf="
                deductionForm.controls['costOfNewAssets'].hasError('required')
              "
              >Please enter cost of new assets</mat-error
            >
          </mat-form-field>
        </div>
        <div class="col-sm-4 spsTp">
          <mat-label>Amount deposited on CGAS*</mat-label>
          <mat-form-field appearance="outline">
            <input
              matInput
              digitsOnly
              placeholder="Amount deposited on CGAS before due date"
              formControlName="investmentInCGAccount"
              required
              maxlength="14"
              matTooltip="Amount deposited on CGAS before due date"
              (change)="calculateDeductionGain()"
              matTooltipClass="tab-tooltip"
              matTooltipPosition="above"
            />
            <mat-error
              *ngIf="
                deductionForm.controls['investmentInCGAccount'].hasError(
                  'required'
                )
              "
              >Please enter amount</mat-error
            >
          </mat-form-field>
        </div>

        <div class="col-sm-4 spsTp">
          <mat-label>Amount of Deduction Claimed*</mat-label>
          <mat-form-field appearance="outline">
            <input
              (change)="calculateDeductionGain()"
              matInput
              readonly
              placeholder="Amount of deduction claimed"
              formControlName="totalDeductionClaimed"
              maxlength="14"
            />
            <mat-error
              *ngIf="
                deductionForm.controls['totalDeductionClaimed'].hasError(
                  'required'
                )
              "
              >Please enter amount</mat-error
            >
          </mat-form-field>
        </div>
      </div>
      <!-- Row Ends -->
    </form>

    <div class="row spsTp bdrTp" *ngIf="deduction">
      <div class="col-sm-9"></div>
      <div class="col-sm-3">
        <button
          type="submit"
          class="tbd-btn save-btn mvRth"
          [disabled]="deductionForm.invalid"
          (click)="save()"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<div class="flex justify-between p-[30px] back-foot">
  <button class="lgtBtn">
    <mat-icon class="icoAdj">keyboard_backspace</mat-icon>
    <span class="font-semibold" (click)="goBack()"
      >&nbsp;Back to Capital Gain Topics</span
    >
  </button>

  <button class="saveBtnIn">
    <span class="font-semibold" (click)="saveAll()">Save All</span>
  </button>
</div>

<ng-template #editEquity>
  <mat-dialog-content>
    <form [formGroup]="selectedFormGroup">
      <div class="row gainHeader">
        <mat-label
          ><b>Type of Capital Gain:</b>
          {{ selectedFormGroup.controls["gainType"].value }} &nbsp;&nbsp;
          <b>Gain Amount:</b>
          {{ selectedFormGroup.controls["capitalGain"].value }}</mat-label
        >
      </div>
      <div class="mvTp">
        <div class="row cardClr">
          <div class="col-sm-4">
            <mat-label>Scrip Name</mat-label>
            <mat-form-field appearance="outline">
              <input
                matInput
                formControlName="nameOfTheUnits"
                placeholder="Scrip Name"
                name="nameOfTheUnits"
                (change)="calculateTotalCG(selectedFormGroup)"
                oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
              />
              <mat-hint style="font-size: 75%"
                >If Scrip Name is not available, we will take
                INNOTREQUIRD</mat-hint
              >
              <mat-error
                *ngIf="
                  selectedFormGroup.get('nameOfTheUnits').hasError('pattern')
                "
                >Enter valid amount.</mat-error
              >
            </mat-form-field>
          </div>
          <div class="col-sm-4">
            <mat-label>Sale Date</mat-label>
            <mat-form-field appearance="outline">
              <input
                matInput
                [min]="minDate"
                [max]="maxDate"
                formControlName="sellDate"
                name="sellDate"
                readonly
                [matDatepicker]="sellDate"
                placeholder="DD/MM/YYYY"
                (dateChange)="
                  calculateGainType(selectedFormGroup);
                  calculateTotalCG(selectedFormGroup);
                  calMaxPurchaseDate(selectedFormGroup.get('sellDate').value)
                "
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="sellDate"
              ></mat-datepicker-toggle>
              <mat-datepicker #sellDate> </mat-datepicker>
              <mat-error
                *ngIf="selectedFormGroup.get('sellDate').hasError('required')"
              >
                Enter valid Date.
              </mat-error>
              <mat-error
                *ngIf="selectedFormGroup.get('sellDate').hasError('dateOrder')"
              >
                Sale date must be after purchase date.
              </mat-error>
            </mat-form-field>
          </div>
          <div class="col-sm-4">
            <mat-label>Buy Date</mat-label>
            <mat-form-field appearance="outline">
              <input
                matInput
                [max]="maxPurchaseDate"
                formControlName="purchaseDate"
                name="purchaseDate"
                [matDatepicker]="purchaseDate"
                placeholder="DD/MM/YYYY"
                readonly
                (dateChange)="
                  calculateGainType(selectedFormGroup);
                  calculateTotalCG(selectedFormGroup)
                "
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="purchaseDate"
              ></mat-datepicker-toggle>
              <mat-datepicker #purchaseDate></mat-datepicker>
              <mat-error
                *ngIf="
                  selectedFormGroup.get('purchaseDate').hasError('dateOrder')
                "
              >
                Purchase date must be before the sale date.
              </mat-error>
            </mat-form-field>
          </div>

          <div
            class="col-sm-4"
            *ngIf="
              checkBuyDateBefore31stJan(selectedFormGroup) &&
              this.bondType === 'listed'
            "
          >
            <mat-label>Buy/Sell Quantity</mat-label>
            <mat-form-field appearance="outline">
              <input
                matInput
                appTwoDigitDecimaNumber
                formControlName="sellOrBuyQuantity"
                placeholder="Sell/Buy Quantity"
                name="sellOrBuyQuantity"
                maxlength="14"
                (change)="calculateTotalCG(selectedFormGroup)"
                oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                (blur)="getPurchaseValue(); getSaleValue()"
              />

              <mat-error
                *ngIf="
                  selectedFormGroup.get('sellOrBuyQuantity').hasError('pattern')
                "
                >Enter valid amount.</mat-error
              >
            </mat-form-field>
          </div>
          <div class="col-sm-4">
            <mat-label>Sale Value</mat-label>
            <mat-form-field appearance="outline">
              <input
                matInput
                formControlName="sellValue"
                placeholder="Sale Value"
                name="sellValue"
                maxlength="14"
                required
                (change)="
                  calculateTotalCG(selectedFormGroup); calculateDeductionGain()
                "
                oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
              />
              <mat-error
                *ngIf="
                  bondType !== 'listed' &&
                  selectedFormGroup.get('sellValue').hasError('pattern')
                "
                >Enter valid amount.</mat-error
              >
            </mat-form-field>
          </div>
          <div class="col-sm-4">
            <mat-label>Buy Value</mat-label>
            <mat-form-field appearance="outline">
              <input
                matInput
                formControlName="purchaseCost"
                placeholder="Buy Value"
                name="purchaseCost"
                maxlength="14"
                (change)="calculateTotalCG(selectedFormGroup)"
                oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
              />
              <mat-error
                *ngIf="
                  selectedFormGroup.get('purchaseCost').hasError('pattern')
                "
                >Enter valid amount.</mat-error
              >
            </mat-form-field>
          </div>

          <div class="col-sm-4">
            <mat-label>Expenses</mat-label>
            <mat-form-field appearance="outline">
              <input
                matInput
                formControlName="sellExpense"
                placeholder="Expenses"
                name="sellExpense"
                maxlength="14"
                digitsOnly
                (change)="
                  calculateTotalCG(selectedFormGroup); calculateDeductionGain()
                "
                oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
              />
              <mat-error
                *ngIf="selectedFormGroup.get('sellExpense').hasError('pattern')"
                >Enter valid amount.</mat-error
              >
            </mat-form-field>
          </div>
          <div
            class="col-sm-4"
            *ngIf="
              checkBuyDateBefore31stJan(selectedFormGroup) &&
              this.bondType === 'listed'
            "
          >
            <mat-label>Sale Price</mat-label>
            <mat-form-field appearance="outline">
              <input
                matInput
                appTwoDigitDecimaNumber
                formControlName="sellValuePerUnit"
                placeholder="Sale Price"
                name="sellValuePerUnit"
                maxlength="14"
                (change)="calculateTotalCG(selectedFormGroup)"
                (blur)="getSaleValue()"
                oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
              />
              <mat-error
                *ngIf="
                  selectedFormGroup.get('sellValuePerUnit').hasError('pattern')
                "
                >Enter valid amount.</mat-error
              >
            </mat-form-field>
          </div>
          <div
            class="col-sm-4"
            *ngIf="
              checkBuyDateBefore31stJan(selectedFormGroup) &&
              this.bondType === 'listed'
            "
          >
            <mat-label>Buy Price</mat-label>
            <mat-form-field appearance="outline">
              <input
                matInput
                appTwoDigitDecimaNumber
                formControlName="purchaseValuePerUnit"
                placeholder="Buy Price"
                name="purchaseValuePerUnit"
                maxlength="14"
                (blur)="getPurchaseValue()"
                oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
              />
              <mat-error
                *ngIf="
                  selectedFormGroup
                    .get('purchaseValuePerUnit')
                    .hasError('pattern')
                "
                >Enter valid amount.</mat-error
              >
            </mat-form-field>
          </div>

          <div
            *ngIf="
              checkBuyDateBefore31stJan(selectedFormGroup) &&
              this.bondType === 'listed'
            "
          >
            <div class="row">
              <div class="col-sm-4 spsTp">
                <mat-label>ISIN Code</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    formControlName="isinCode"
                    placeholder="ISIN Code"
                    name="isinCode"
                    (blur)="calculateFMV(selectedFormGroup)"
                    (change)="calculateFMV(selectedFormGroup)"
                  />
                  <mat-hint style="font-size: 75%"
                    >If ISIN Code is not available, we will take
                    INNOTREQUIRD</mat-hint
                  >
                </mat-form-field>
              </div>

              <div class="col-sm-4 spsTp">
                <mat-label>FMV Per Unit as on 31st Jan 2018</mat-label>
                <mat-form-field appearance="outline">
                  <input
                    matInput
                    formControlName="fmvAsOn31Jan2018"
                    placeholder="FMV"
                    name="fmvAsOn31Jan2018"
                    (change)="calculateTotalCG(selectedFormGroup)"
                  />
                </mat-form-field>
              </div>
              <div class="col-sm-4 spsTp">
                <mat-label>Cost of acquisition </mat-label>

                <mat-form-field appearance="outline">
                  <input
                    matInput
                    formControlName="grandFatheredValue"
                    placeholder="GrandFathered Value "
                    name="grandFatheredValue"
                    maxlength="14"
                    matTooltip="Cost of acquisition(as per grandfathering)"
                    matTooltipClass="tab-tooltip"
                    matTooltipPosition="above"
                    readonly
                    (change)="calculateTotalCG(selectedFormGroup)"
                    oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                  />
                  <mat-hint style="font-size: 75%"
                    >As per grandfathering</mat-hint
                  >
                  <mat-error
                    *ngIf="
                      selectedFormGroup
                        .get('grandFatheredValue')
                        .hasError('pattern')
                    "
                    >Enter valid amount.</mat-error
                  >
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row spsTp bdrTp">
        <div class="col-sm-9"></div>
        <div class="col-sm-3">
          <button
            type="submit"
            class="tbd-btn save-btn mvRth"
            (click)="addDialogRef.close(this.selectedFormGroup.value)"
          >
            Save
          </button>
        </div>
      </div>
    </form>
  </mat-dialog-content>
</ng-template>
